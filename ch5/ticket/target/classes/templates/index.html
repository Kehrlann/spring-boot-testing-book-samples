<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Support Tickets</title>
    <style>
        body { font-family: system-ui, sans-serif; max-width: 900px; margin: 2rem auto; padding: 0 1rem; }
        table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        th, td { text-align: left; padding: 0.5rem; border-bottom: 1px solid #ddd; }
        th { background: #f5f5f5; }
        .badge { padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.85em; }
        .OPEN { background: #dbeafe; color: #1e40af; }
        .IN_PROGRESS { background: #fef3c7; color: #92400e; }
        .RESOLVED { background: #d1fae5; color: #065f46; }
        .CLOSED { background: #e5e7eb; color: #374151; }
        .CRITICAL { color: #dc2626; font-weight: bold; }
        .HIGH { color: #ea580c; }
        .MEDIUM { color: #ca8a04; }
        .LOW { color: #65a30d; }
        #notifications { margin-bottom: 1.5rem; display: flex; flex-direction: column; gap: 0.4rem; min-height: 3.5rem; padding: 0.75rem; border: 1px solid #e5e7eb; border-radius: 8px; background: #fafafa; }
        #notifications .notif-empty { color: #9ca3af; font-size: 0.9rem; }
        .notif { display: flex; align-items: center; gap: 0.6rem; padding: 0.5rem 0.75rem; border-radius: 6px; font-size: 0.9rem; background: #f0f9ff; border-left: 3px solid #2563eb; color: #1e3a5f; animation: fadeIn 0.3s ease; }
        .notif .notif-type { font-weight: 600; font-size: 0.75rem; text-transform: uppercase; padding: 0.15rem 0.4rem; border-radius: 3px; background: #dbeafe; color: #1e40af; flex-shrink: 0; }
        .notif .notif-type.ASSIGNED { background: #fef3c7; color: #92400e; }
        .notif .notif-type.STATUS { background: #e0e7ff; color: #3730a3; }
        .notif .notif-msg { flex: 1; }
        .notif .notif-time { color: #9ca3af; font-size: 0.8rem; flex-shrink: 0; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-4px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <h1>Support Tickets</h1>
    <div id="notifications"><span class="notif-empty">No recent notifications.</span></div>
    <p><a th:href="@{/tickets/new}" style="display:inline-block;padding:0.5rem 1rem;background:#2563eb;color:white;border-radius:4px;text-decoration:none;">+ New Ticket</a></p>
    <table>
        <thead>
            <tr>
                <th>#</th>
                <th>Title</th>
                <th>Status</th>
                <th>Priority</th>
                <th>Assigned To</th>
                <th>Created</th>
            </tr>
        </thead>
        <tbody>
            <tr th:each="ticket : ${tickets}">
                <td th:text="${ticket.id}"></td>
                <td><a th:href="@{'/tickets/' + ${ticket.id}}" th:text="${ticket.title}" style="color:#2563eb;text-decoration:none;"></a></td>
                <td><span class="badge" th:classappend="${ticket.status}" th:text="${ticket.status}"></span></td>
                <td><span th:classappend="${ticket.priority}" th:text="${ticket.priority}"></span></td>
                <td th:text="${ticket.assignedAgent != null ? ticket.assignedAgent.name : 'Unassigned'}"></td>
                <td th:text="${ticket.createdAt}"></td>
            </tr>
        </tbody>
    </table>
<script>
(function () {
    var container = document.getElementById('notifications');
    var source = new EventSource('/api/notifications/stream');
    source.addEventListener('ticket-notification', function (e) {
        var data = JSON.parse(e.data);
        var el = document.createElement('div');
        el.className = 'notif';
        var now = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        el.innerHTML =
            '<span class="notif-type ' + data.eventType + '">' + data.eventType + '</span>' +
            '<span class="notif-msg">' + data.message + '</span>' +
            '<span class="notif-time">' + now + '</span>';
        var empty = container.querySelector('.notif-empty');
        if (empty) empty.remove();
        container.prepend(el);
        while (container.querySelectorAll('.notif').length > 2) {
            container.removeChild(container.querySelector('.notif:last-of-type'));
        }
    });
})();
</script>
</body>
</html>
